import{_ as e,a,M as r,k as l,m as t,N as o,P as i,S as n,b as d,i as s,e as u,w as c,g as p,a3 as f,Z as g,E as m,Y as b,r as y,o as v,I as w,f as h,y as x,t as _,F as M,n as P,x as B,j as U,X as F,z as G,A as k}from"./index.ad8f3002.js";import{d as C,i as N}from"./index.6f43866f.js";import{g as T,P as I,a as j,p as V,b as A,c as L,G as O}from"./service.a6f262b5.js";import{g as $}from"./getQuery.06af59d7.js";const E=e=>(G("data-v-7e6ad748"),e=e(),k(),e),R={style:{margin:"20px 0"}},q=x("成本信息表下载"),D=x("报价"),z=x("不报价"),Q=E((()=>s("div",{class:"card-header"},[s("span",null,"NRE")],-1))),S=E((()=>s("div",{class:"card-header"},[s("span",null,"单价表")],-1))),X=E((()=>s("div",{class:"card-header"},[s("span",null,"汇总分析表")],-1))),Y={key:0},Z={key:1},H=x("年份维度对比"),J=x("计算"),K=x("计算"),W=E((()=>s("div",{id:"unitpriceChart"},null,-1))),ee=E((()=>s("div",{id:"revenueGrossMarginChart"},null,-1))),ae={style:{float:"right",padding:"20px 0"},m:"2"},re=x("在线预览NRE核价表"),le=x("在线预览核价表"),te=x("点击生成待审批的报价表"),oe={class:"dialog-footer"},ie=x("确定");var ne=e(a({__name:"index",setup(e){let a=$();const G=U(),k=e=>{var a;return`${null==(a=e.grossMargin)?void 0:a.toFixed(2)}`};let E=r(!1);const ne=r(!1);let de={title:{text:"项目单价对比"},tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},legend:{},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",data:["目标价（内部）","目标价（客户）","本次报价","上一轮"]},yAxis:[{type:"value",name:"单价",min:0,max:1e3,interval:200,axisLabel:{formatter:"{value} 元"}},{type:"value",name:"毛利率",min:0,max:.5,interval:.02,axisLabel:{formatter:"{value}"}}],series:[]},se={title:{text:"收入和毛利率对比"},xAxis:{type:"category",data:["目标价","本次报价","上一轮"]},tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},legend:{},yAxis:[{type:"value",name:"收入",min:0,max:1e3,interval:200,axisLabel:{formatter:"{value} 元"}},{type:"value",name:"毛利率",min:0,max:.5,interval:.02,axisLabel:{formatter:"{value}"}}],series:[]},ue=null,ce=null;const pe=(e,a)=>{let r=document.getElementById(e);if(r){var l=N(r);return l.setOption(a),l}},fe=l({tableData:[],nre:[],unitPrice:[],pooledAnalysis:[],productBoard:[],allInteriorGrossMargin:"",allClientGrossMargin:"",projectBoard:[],auditFlowId:1,dialogTable:[],allGrossMargin:0}),ge=C((async(e,a,r,l)=>{let{result:t}=await V(e,fe.auditFlowId,r)||{};const{grossMargin:o}=(null==t?void 0:t.productBoardGrosses[0])||"";fe.productBoard[a][l]=o,fe.allGrossMargin=t.allGrossMargin;const i=Pe("offeGrossMargin"),n=Pe("offerUnitPrice");be(i,n),me()}),300),me=()=>{de.series=fe.productBoard.map((e=>({name:e.productName+e.interiorTargetUnitPrice,type:"bar",stack:"total",label:{show:!0},emphasis:{focus:"series"},data:[e.interiorTargetUnitPrice,e.clientTargetUnitPrice,e.offerUnitPrice].concat(e.oldOffer.map((e=>e.unitPrice)))}))),de.series.push({yAxisIndex:1,name:"整体毛利率",type:"line",data:[Number(fe.allClientGrossMargin).toFixed(2),Number(fe.allInteriorGrossMargin).toFixed(2)]}),ue.setOption(de),se.series=fe.projectBoard.map((e=>{if("销售收入"===e.projectName)return{name:e.projectName,type:"bar",stack:"total",label:{show:!0},emphasis:{focus:"series"},data:[e.interiorTarget.grossMarginNumber,e.clientTarget.grossMarginNumber]}}));let e=[];fe.projectBoard.forEach((a=>{"毛利率"===a.projectName&&(e.push(a.clientTarget.grossMargin),e.push(a.interiorTarget.grossMargin))})),se.series.push({yAxisIndex:1,name:"毛利率",type:"line",data:e}),ce.setOption(se)},be=async(e,a)=>{let{result:r}=await A(fe.auditFlowId,e,a);r.forEach(((e,a)=>{fe.projectBoard[a].offer={grossMarginNumber:e.value}}))},ye=e=>{const a=e?"您确定要报价嘛！":"您确定要取消报价吗？请填写原因！";g[e?"confirm":"prompt"](a,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async a=>{(await L({unitPrice:fe.unitPrice,pooledAnalysis:fe.pooledAnalysis,productBoard:{allInteriorGrossMargin:fe.allInteriorGrossMargin,allClientGrossMargin:fe.allClientGrossMargin,productBoard:fe.productBoard},projectBoard:fe.projectBoard,isOffer:e,auditFlowId:fe.auditFlowId,nre:fe.nre,NoOfferReason:e?"":null==a?void 0:a.value})).success&&m.success("操作成功")}))},ve=async()=>{const e=await T(fe.auditFlowId,"成本信息表"),a=new FileReader;a.readAsDataURL(e),a.onload=function(){let a=URL.createObjectURL(new Blob([e])),r=document.createElement("a");document.body.appendChild(r),r.href=a,r.download="成本信息表.xlsx",r.target="_blank",r.click(),r.remove()}},we=async()=>{g.confirm("确定执行该操作?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{(await I({unitPrice:fe.unitPrice,pooledAnalysis:fe.pooledAnalysis,productBoard:{allInteriorGrossMargin:fe.allInteriorGrossMargin,allClientGrossMargin:fe.allClientGrossMargin,productBoard:fe.productBoard},projectBoard:fe.projectBoard,auditFlowId:fe.auditFlowId,nre:fe.nre})).success&&(G.push({path:"/demandApply/result",query:a}),m.success("操作成功"))}))},he=()=>{G.push({path:"/nupriceManagement/productPriceList",query:{...a,disabled:!0}})},xe=()=>{G.push({path:"/nre/nrePricelist",query:a})},_e=()=>{Me(),E.value=!0},Me=async()=>{const e=Pe("offeGrossMargin"),a=Pe("offerUnitPrice"),{result:r}=await O({id:fe.auditFlowId,unitPrice:a,grossMargin:e});fe.dialogTable=r},Pe=(e,a)=>{if(0===fe.productBoard.length)return 0;if(1===fe.productBoard.length)return Number(fe.productBoard[0][e])||0;const r=fe.productBoard.map((a=>Number(a[e]||0))),l=null==r?void 0:r.reduce(((e,a)=>e+a));return a?l/fe.productBoard.length:l};return t((()=>{})),o((async()=>{(async()=>{const e=b.service({lock:!0,text:"Loading",background:"rgba(0, 0, 0, 0.7)"});try{ue=pe("unitpriceChart",de),ce=pe("revenueGrossMarginChart",se),fe.auditFlowId=Number(a.auditFlowId);let{result:r}=await j(fe.auditFlowId),{nre:l,unitPrice:t,pooledAnalysis:o,productBoard:i,projectBoard:n}=r;fe.nre=l,fe.unitPrice=t,fe.unitPrice,fe.pooledAnalysis=o,fe.productBoard=i.productBoard,fe.allInteriorGrossMargin=i.allInteriorGrossMargin,fe.allInteriorUnitPrice=i.allInteriorUnitPrice,fe.allClientUnitPrice=i.allClientUnitPrice,fe.allClientGrossMargin=i.allClientGrossMargin,fe.projectBoard=n,me(),ne.value=!1,e.close()}catch(r){ne.value=!1,e.close()}})()})),i((()=>{ue.dispose(),ce.dispose()})),n((()=>{})),(e,a)=>{const r=y("el-button"),l=y("el-button-group"),t=y("el-table-column"),o=y("el-input-number"),i=y("el-input"),n=y("el-table"),g=y("el-card"),m=y("el-row"),b=y("el-descriptions-item"),U=y("el-descriptions"),G=y("el-dialog"),C=F("havedone");return v(),d("div",null,[s("div",R,[u(r,{type:"primary",onClick:ve,style:{"margin-left":"10px"}},{default:c((()=>[q])),_:1}),u(l,{style:{"margin-right":"10px",float:"right"}},{default:c((()=>[w((v(),h(r,{type:"primary",onClick:a[0]||(a[0]=e=>ye(1))},{default:c((()=>[D])),_:1})),[[C]]),w((v(),h(r,{type:"primary",onClick:a[1]||(a[1]=e=>ye(0))},{default:c((()=>[z])),_:1})),[[C]])])),_:1})]),u(g,{class:"card"},{header:c((()=>[Q])),default:c((()=>[u(n,{data:fe.nre,style:{width:"100%"},border:"","show-summary":""},{default:c((()=>[u(t,{type:"index",width:"50"}),u(t,{label:"费用名称",width:"180",prop:"formName"}),u(t,{prop:"pricingMoney",label:"核价金额",width:"180"}),u(t,{label:"报价系数",width:"180"},{default:c((e=>[u(o,{modelValue:e.row.offerCoefficient,"onUpdate:modelValue":a=>e.row.offerCoefficient=a,"controls-position":"right",type:"number",min:0,onBlur:()=>{return a=e.row,r=e.$index,void(fe.nre[r].offerMoney=a.offerCoefficient*a.pricingMoney);var a,r}},null,8,["modelValue","onUpdate:modelValue","onBlur"])])),_:1}),u(t,{label:"报价金额",width:"180",prop:"offerMoney"},{default:c((({row:e})=>[x(_(e.offerCoefficient*e.pricingMoney),1)])),_:1}),u(t,{label:"备注"},{default:c((({row:e})=>[u(i,{modelValue:e.remark,"onUpdate:modelValue":a=>e.remark=a},null,8,["modelValue","onUpdate:modelValue"])])),_:1})])),_:1},8,["data"])])),_:1}),u(g,{class:"card"},{header:c((()=>[S])),default:c((()=>[fe.unitPrice.length>0?(v(),h(n,{key:0,data:fe.unitPrice,style:{width:"100%"},border:""},{default:c((()=>[u(t,{label:"产品",prop:"productName",width:"150"}),u(t,{label:"单车产品数量",prop:"productNumber",width:"150"}),(v(!0),d(M,null,P(fe.unitPrice[0].grossMarginList,((e,a)=>(v(),h(t,{label:e.grossMargin+"%",key:a,width:"150"},{default:c((e=>{var r;return[s("span",null,_(null==(r=e.row.grossMarginList[a])?void 0:r.grossMarginNumber.toFixed(2)),1)]})),_:2},1032,["label"])))),128))])),_:1},8,["data"])):B("",!0)])),_:1}),u(g,{class:"card"},{header:c((()=>[X])),default:c((()=>[fe.pooledAnalysis.length>0?(v(),h(n,{key:0,data:fe.pooledAnalysis,border:""},{default:c((()=>{var e;return[u(t,{label:"项目名称",prop:"projectName",width:"150"}),(v(!0),d(M,null,P(null==(e=fe.pooledAnalysis[0])?void 0:e.grossMarginList,((e,a)=>(v(),h(t,{label:e.grossMargin+"%",key:a,width:"150"},{default:c((({row:e})=>{var r,l;return["毛利率"!==e.projectName?(v(),d("span",Y,_(null==(r=e.grossMarginList[a])?void 0:r.grossMarginNumber.toFixed(2)),1)):(v(),d("span",Z,_(`${(null==(l=e.grossMarginList[a])?void 0:l.grossMarginNumber).toFixed(2)||0} %`),1))]})),_:2},1032,["label"])))),128))]})),_:1},8,["data"])):B("",!0)])),_:1}),u(g,{class:"card"},{default:c((()=>[u(m,{justify:"end",m:"2"},{default:c((()=>[u(r,{onClick:_e,type:"primary"},{default:c((()=>[H])),_:1})])),_:1}),u(n,{data:fe.productBoard,border:""},{default:c((()=>[u(t,{label:"产品",prop:"productName"}),u(t,{label:"单车产品数量",prop:"productNumber"}),u(t,{label:"目标价（内部）",width:"300"},{default:c((()=>[u(t,{label:"单价",prop:"interiorTargetUnitPrice"},{default:c((({row:e})=>{var a;return[x(_(null==(a=null==e?void 0:e.interiorTargetUnitPrice)?void 0:a.toFixed(2)),1)]})),_:1}),u(t,{label:"毛利率",prop:"interiorTargetGrossMargin"},{default:c((({row:e})=>{var a;return[x(_(`${null==(a=e.interiorTargetGrossMargin)?void 0:a.toFixed(2)} %`),1)]})),_:1})])),_:1}),u(t,{label:"目标价（客户）"},{default:c((()=>[u(t,{label:"单价",prop:"clientTargetUnitPrice"},{default:c((e=>[u(i,{modelValue:e.row.clientTargetUnitPrice,"onUpdate:modelValue":a=>e.row.clientTargetUnitPrice=a},{append:c((()=>[u(r,{onClick:a=>p(ge)(e.row,e.$index,e.row.clientTargetUnitPrice,"clientTargetGrossMargin")},{default:c((()=>[J])),_:2},1032,["onClick"])])),_:2},1032,["modelValue","onUpdate:modelValue"])])),_:1}),u(t,{label:"毛利率",prop:"clientTargetGrossMargin"},{default:c((({row:e})=>{var a;return[x(_(`${null==(a=e.clientTargetGrossMargin)?void 0:a.toFixed(2)} %`),1)]})),_:1})])),_:1}),u(t,{label:"本次报价"},{default:c((()=>[u(t,{label:"单价"},{default:c((e=>[u(i,{modelValue:e.row.offerUnitPrice,"onUpdate:modelValue":a=>e.row.offerUnitPrice=a},{append:c((()=>[u(r,{onClick:a=>p(ge)(e.row,e.$index,e.row.offerUnitPrice,"offeGrossMargin")},{default:c((()=>[K])),_:2},1032,["onClick"])])),_:2},1032,["modelValue","onUpdate:modelValue"])])),_:1}),u(t,{label:"毛利率",prop:"offeGrossMargin"},{default:c((({row:e})=>{var a;return[x(_(`${null==(a=e.offeGrossMargin)?void 0:a.toFixed(2)} %`),1)]})),_:1})])),_:1}),(v(!0),d(M,null,P(fe.productBoard.length>0?fe.productBoard[0].oldOffer:[],((e,a)=>(v(),h(t,{label:"第"+(a+1)+"轮",key:a,width:"300"},{default:c((()=>[u(t,{label:"单价"},{default:c((()=>[s("template",null,[s("div",null,_(e.unitPrice.toFixed(2)),1)])])),_:2},1024),u(t,{label:"毛利率"},{default:c((()=>[s("template",null,[s("div",null,_(`${e.grossMargin.toFixed(2)} %`),1)])])),_:2},1024)])),_:2},1032,["label"])))),128))])),_:1},8,["data"]),u(U,{title:"",border:"",column:1},{default:c((()=>[u(b,{label:"目标价(内部)整套单价"},{default:c((()=>[x(_(fe.allInteriorUnitPrice),1)])),_:1}),u(b,{label:"目标价(客户)整套单价"},{default:c((()=>[x(_(Pe("clientTargetUnitPrice")),1)])),_:1}),u(b,{label:"本次报价整套单价"},{default:c((()=>[x(_(Pe("offerUnitPrice")),1)])),_:1}),u(b,{label:"目标价(内部)平均单价"},{default:c((()=>[x(_(Pe("interiorTargetUnitPrice","average").toFixed(2)),1)])),_:1}),u(b,{label:"目标价(客户)平均单价"},{default:c((()=>[x(_(Pe("clientTargetUnitPrice","average").toFixed(2)),1)])),_:1}),u(b,{label:"本次报价平均单价"},{default:c((()=>[x(_(Pe("offerUnitPrice","average").toFixed(2)),1)])),_:1}),u(b,{label:"目标价(内部)整套毛利率"},{default:c((()=>[x(_(`${Number(fe.allClientGrossMargin).toFixed(2)} %`),1)])),_:1}),u(b,{label:"目标价(客户)整套毛利率"},{default:c((()=>[x(_(`${Number(fe.allInteriorGrossMargin).toFixed(2)} %`),1)])),_:1}),u(b,{label:"本次报价整套毛利率"},{default:c((()=>{var e;return[x(_(`${(null==(e=fe.allGrossMargin)?void 0:e.toFixed(2))||0} %`),1)]})),_:1})])),_:1})])),_:1}),u(g,{class:"card"},{default:c((()=>[u(n,{data:fe.projectBoard,style:{width:"100%"},border:""},{default:c((()=>{var e;return[u(t,{label:"项目",prop:"projectName"}),u(t,{label:"目标价（内部）"},{default:c((e=>{var a;return[s("div",null,_(null==(a=e.row.interiorTarget)?void 0:a.grossMarginNumber.toFixed(2)),1)]})),_:1}),u(t,{label:"目标价（客户）"},{default:c((e=>{var a;return[s("div",null,_(null==(a=e.row.clientTarget)?void 0:a.grossMarginNumber.toFixed(2)),1)]})),_:1}),u(t,{label:"本次报价"},{default:c((e=>{var a;return[s("div",null,_(null==(a=e.row.offer)?void 0:a.grossMarginNumber.toFixed(2)),1)]})),_:1}),(v(!0),d(M,null,P(fe.projectBoard.length>0?null==(e=fe.projectBoard[0])?void 0:e.oldOffer:[],((e,a)=>(v(),h(t,{label:"第"+(a+1)+"轮",key:a},{default:c((e=>[u(i,{modelValue:e.row.oldOffer[a].grossMargin,"onUpdate:modelValue":r=>e.row.oldOffer[a].grossMargin=r},null,8,["modelValue","onUpdate:modelValue"]),u(i,{modelValue:e.row.oldOffer[a].unitPrice,"onUpdate:modelValue":r=>e.row.oldOffer[a].unitPrice=r},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1032,["label"])))),128))]})),_:1},8,["data"])])),_:1}),u(g,{m:"2"},{default:c((()=>[W])),_:1}),u(g,{m:"2"},{default:c((()=>[ee])),_:1}),s("div",ae,[u(r,{onClick:xe,type:"primary"},{default:c((()=>[re])),_:1}),u(r,{onClick:he,type:"primary"},{default:c((()=>[le])),_:1}),u(r,{onClick:we,type:"primary"},{default:c((()=>[te])),_:1})]),u(G,{modelValue:p(E),"onUpdate:modelValue":a[3]||(a[3]=e=>f(E)?E.value=e:E=e),title:"年份维度对比",width:"50%",style:{height:"300px"}},{footer:c((()=>[s("span",oe,[u(r,{type:"primary",onClick:a[2]||(a[2]=e=>f(E)?E.value=!1:E=!1)},{default:c((()=>[ie])),_:1})])])),default:c((()=>[(v(!0),d(M,null,P(fe.dialogTable,(e=>(v(),d("div",{key:e,class:"common-card"},[u(g,{class:"table-wrap",header:e.project},{default:c((()=>[u(n,{data:[e],style:{width:"100%"}},{default:c((()=>[(v(!0),d(M,null,P(e.yearList,((e,a)=>(v(),h(t,{key:e,prop:`yearList.${a}.value`,label:e.year},{default:c((({row:e})=>[x(_(e.yearList[a].value.toFixed(2)),1)])),_:2},1032,["prop","label"])))),128)),u(t,{prop:"grossMargin",label:"毛利率",formatter:k}),u(t,{prop:"totak",label:"总和"})])),_:2},1032,["data"])])),_:2},1032,["header"])])))),128))])),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-7e6ad748"]]);export{ne as default};
